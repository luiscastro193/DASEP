function e(e){return new Promise((e=>setTimeout(e,1500)))}window.request=async function(e,t){let n=await fetch(e,t);if(n.ok)return n;throw n},window.htmlToElement=function(e){let t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild},window.AuxEvent=class{constructor(){this.event=document.createElement("e"),this.aux=new Event("e")}addListener(e,t){let n=this.event;n.addEventListener("e",(function a(){document.contains(e)?t():n.removeEventListener("e",a)}))}dispatch(){this.event.dispatchEvent(this.aux)}},window.Observable=class{constructor(e){this.variable=e,this.event=new AuxEvent}get value(){return this.variable}set value(e){this.variable=e,this.event.dispatch()}subscribe(e,t){this.event.addListener(e,t)}};const t=async function(){let t;for(;!t;)t=await request("data.json").then((e=>({data:e.json(),date:e.headers.get("last-modified")}))).catch(e);return t}(),n=t.then((e=>e.data)),a={title:document.querySelector("h1").innerText,origHeader:document.querySelector("header"),main:document.querySelector("main").innerHTML};function l(){alert("Copia el enlace para guardar la selección")}function i(e){e?.preventDefault();let t=e?.currentTarget?.href||location.href;navigator.share?navigator.share({url:t}):navigator.clipboard?navigator.clipboard.writeText(t).then((()=>alert("Enlace copiado al portapapeles"))).catch(l):l()}a.header=t.then((e=>(e.date&&a.origHeader.querySelector(".main-info").append(`\n\nFecha de última actualización: ${new Date(e.date).toLocaleDateString()}`),a.origHeader.innerHTML)));const r=import("https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.min.js");async function o(e,t){await r;let n=new zip.ZipWriter(new zip.BlobWriter("application/zip"));await Promise.all(e.map((async e=>n.add(e.path,await e.stream))));let a=URL.createObjectURL(await n.close()),l=document.createElement("a");l.href=a,l.download=`${t}.zip`,document.body.append(l),l.click(),URL.revokeObjectURL(a),l.remove()}let s=new Promise((e=>{document.head.querySelector("[data-id=vegaEmbed]").onload=()=>e()})),c=[];function d(){let e=location.pathname;return e.endsWith("/")?e:e+"/"}const u=n.then((e=>Object.keys(e.regiones)));async function p(e,t){let[n,a]=e.split(";");n=`${d()}data/${n}.json`,a=a?a.split(","):[];let l=t?(await u).filter((e=>!t.includes(e))):[];if(!a.some((e=>l.some((t=>e.includes(t))))))return n;let i=await request(n).then((e=>e.text())),r=l.map((e=>`indexof(datum.M, '${e}') == -1`)).join(" && ");return JSON.parse(i.replace("true == true",r))}function h(e){let t=e.split(";")[0].split("/");return t[t.length-1]}async function m(e,t,n){let a=await p(t,n);await s;let l=(await vegaEmbed(e,a,{renderer:"canvas",downloadFileName:h(t)})).finalize;n&&function(e,t){let n=`${d()}data/${t.split(";")[0]}.xlsx`,a=htmlToElement(`<a href="${n}" target="_blank" rel="noopener" download>Download table</a>`);e.querySelector(".vega-actions").prepend(a)}(e,t),setTimeout((()=>c.push([e,l])),0)}function f(e){if(document.body.contains(e[0]))return!0;e[1]()}async function v(e,t){let n=await p(e,t);"string"==typeof n&&(n=await request(n).then((e=>e.json()))),await s;let a=new vega.View(vega.parse(await vegaLite.compile(n).spec),{renderer:"none"}).finalize();return new Blob([await a.toSVG()]).stream()}function b(e){let t=$(e);return[[...S(t,e).values()].map((e=>[...e.values()])).flat().map((e=>[...e.values()])).flat(2),t.m]}setInterval((function(){c=c.filter(f)}),1e3);let g=!1;let y=!1;async function w(){let e=await n,t=htmlToElement(`<header class="main-header-container">\n\t\t<a class="home-link" href=" "><i class="fa-solid fa-house"></i></a>\n\t\t<header class="main-header">\n\t\t\t<label for="main-info-checkbox"><h1>${a.title} <span><i class="fa-solid fa-circle-info"></i></span></h1></label>\n\t\t\t<input id="main-info-checkbox" type="checkbox">\n\t\t\t<p class="main-info">${e.infoResultados}</p>\n\t\t</header>\n\t\t<section class="downloads">\n\t\t\t<span><i class="fa-solid fa-download"></i></span>\n\t\t\t<a href="${location.href}">Enlace</a>\n\t\t\t<a role="link">Tablas.zip</a>\n\t\t\t<a role="link">Gráficas.zip</a>\n\t\t</section>\n\t</header>`);t.querySelector(".home-link").onclick=t=>function(e,t){e.preventDefault();let n=$(t);history.pushState(n,""," "),dispatchEvent(new PopStateEvent("popstate",{state:n}))}(t,e);let l=t.querySelectorAll(".downloads > a");return l[0].onclick=i,l[1].onclick=t=>async function(e,t){if(g)return;g=!0,e.target.style.cursor="wait";let n=b(t)[0].map((e=>({path:`${h(e)}.xlsx`,stream:request(`${d()}data/${e.split(";")[0]}.xlsx`).then((e=>e.body))})));await o(n,"Tablas"),e.target.style.cursor="",g=!1}(t,e),l[2].onclick=t=>async function(e,t){if(y)return;y=!0,e.target.style.cursor="wait";let[n,a]=b(t),l=n.map((e=>({path:`${h(e)}.svg`,stream:v(e,a)})));await o(l,"Gráficas"),e.target.style.cursor="",y=!1}(t,e),t}function k(e){return e.estimadores}function $(e){let t=new URLSearchParams(location.hash.substring(1)),n={};for(let[e,a]of t)n[e]=a.split(" ");return function(e,t){let n=k(t);return!!(e.var&&e.est&&e.seg&&e.m&&e.var.length&&e.est.length&&e.seg.length&&e.m.length&&e.var.every((e=>t.variables[e]))&&e.est.every((e=>n[e]))&&e.seg.every((e=>t.segmentaciones[e]))&&(e.m=e.m.map((e=>e.replace(/_/g," "))),e.m.every((e=>t.regiones[e]))))}(n,e)&&n}function E(e,t,n){let a=e.split(";")[1].split(","),l=n.filter((e=>!t.includes(e)));return a.some((e=>!l.some((t=>e.includes(t)))))}function S(e,t){let n=Object.keys(t.regiones),a=new Map;for(let l of e.var){let i=t.variables[l].archivos,r=new Map;for(let t of e.est){let a=i[t];if(!a)continue;let l=new Map;for(let t of e.seg){let i=a[t];i&&(i=i.filter((t=>E(t,e.m,n))),i.length&&l.set(t,i))}l.size&&r.set(t,l)}r.size&&a.set(l,r)}return a}async function T(){let e=location.hash,t=htmlToElement('<main class="results-page"></main>'),a=await n;if(e!=location.hash)return t;let l=$(a);if(!l)return location.hash="",t;let r=S(l,a);if(!r.size)return t.append(htmlToElement("<p>Ningún estimador seleccionado está disponible para las variables y regiones seleccionadas.</p>")),t;let o,s=k(a),c=0;if(l.seg.length>1?c=3:l.est.length>1?c=2:l.var.length>1&&(c=1),c>=1){o=htmlToElement('<h2 class="var-title">Índice de contenidos seleccionados</h2>'),t.append(o);for(let[e,n]of r.entries()){let l=htmlToElement(`<a class="index-link" role="link"><span>${a.variables[e].nombre}</span></a>`);if(l.onclick=()=>t.querySelector(`#var-${e}`).scrollIntoView(),t.append(l),c>=2)for(let[l,i]of n.entries()){let n=htmlToElement(`<a class="index-link indent" role="link"><span>${s[l]}</span></a>`);if(n.onclick=()=>t.querySelector(`#var-${e}-est-${l}`).scrollIntoView(),t.append(n),c>=3)for(let n of i.keys()){let i=htmlToElement(`<a class="index-link indent-2" role="link"><span>${a.segmentaciones[n]}</span></a>`);i.onclick=()=>t.querySelector(`#var-${e}-est-${l}-seg-${n}`).scrollIntoView(),t.append(i)}}}}function d(e){o.scrollIntoView(),e.preventDefault()}function u(){let e=htmlToElement('<a class="index-back"><i class="fa-solid fa-arrow-turn-up"></i></a>');return e.onclick=d,e}function p(e,t,n,a){let l=new URLSearchParams({var:e,est:t,seg:n,m:a.map((e=>e.replace(/ /g,"_"))).join(" ")}),r=htmlToElement(`<a class="chart-link" href="${"#?"+l.toString()}" target="_blank"><i class="fa-solid fa-link"></i></a>`);return r.onclick=i,r}for(let[e,n]of r.entries()){let i=htmlToElement(`<h2 id="var-${e}" class="var-title">Variable seleccionada: ${a.variables[e].nombre}</h2>`);c>=1&&i.append(u()),t.append(i);for(let[i,r]of n.entries()){let n=htmlToElement(`<label id="var-${e}-est-${i}" for="${e}-${i}" class="est-title"><h2>Estimador seleccionado: ${s[i]} <span><i class="fa-solid fa-circle-info"></i></span></h2></label>`);c>=2&&n.append(u()),t.append(n,htmlToElement(`<input id="${e}-${i}" type="checkbox">`),htmlToElement(`<p>${a.descripciones[i]}</p>`));for(let[n,o]of r.entries()){let r=htmlToElement(`<h2 id="var-${e}-est-${i}-seg-${n}" class="est-title">Segmentación seleccionada: ${a.segmentaciones[n]}</h2>`);c>=3&&r.append(u()),r.append(p(e,i,n,l.m)),t.append(r);for(let e of o){let n=htmlToElement('<div class="chart-container"><div></div></div>');m(n.querySelector("div"),e,l.m),t.append(n)}}}}return t}async function q(){return htmlToElement(`<header class="main-header-container main-selection-header">\n\t\t${await a.header}\n\t</header>`)}function x(e,t,n=!1){return n=n?" checked":"",htmlToElement(`<label><input ${t?`name="${t}"`:""} type="checkbox"${n}><span>${e}</span></label>`)}function j(e,t){let n=e.querySelector("input"),a=t.map((e=>e.querySelector("input")));function l(){a.every((e=>e.checked))?n.checked=!0:a.some((e=>!e.checked))&&(n.checked=!1)}n.addEventListener("change",(()=>{for(let e of a)e.checked=n.checked}));for(let e of a)e.addEventListener("change",l);l()}function L(e){return[...new FormData(e).keys()]}function z(e,t,n,a){var l;if(l=e.trim(),""==(e=l.normalize("NFKD").replace(/\p{Diacritic}/gu,"").toLowerCase()))t.querySelectorAll("input").forEach((e=>{e.checked=!1}));else{e=e.split(/\s+/);for(let a of t.children){let t=Array.from(a.querySelectorAll("input")),l=t.shift();l.checked=!1;let i=t.shift();i.checked=!0;for(let a of t){let t=n.variables[a.name].texto;e.every((e=>t.includes(e)))?(a.checked=!0,l.checked=!0):(a.checked=!1,i.checked=!1)}}}a()}function O(e){let t=[...e.querySelectorAll("input")];t.some((e=>e.checked))&&(t[0].checked=!0)}async function A(e){let t=htmlToElement(`<main class="selection-page">${a.main}</main>`),l=0,i=await n,r=new Set(e?Object.values(e).flat():i.activados),o=t.querySelector("#var-selection");for(let[e,t]of Object.entries(i.bloques)){let n=htmlToElement(`<div>\n\t\t\t<input id="block${++l}-checkbox" type="checkbox">\n\t\t\t<label for="block${l}-checkbox"><span>${e}</span><span><i class="fa-solid fa-play"></i></span></label>\n\t\t</div>`),a=x("Todas"),s=t.map((e=>x(i.variables[e].nombre,e,r.has(e))));j(a,s),n.append(a,...s),O(n),o.append(n)}let s=t.querySelector("#est-selection"),c=x("Todas las tablas"),d=Object.entries(i.estimadores).map((e=>x(e[1],e[0],r.has(e[0]))));j(c,d),s.append(c,...d);let u=t.querySelector("#seg-selection"),p=x("Todas"),h=Object.entries(i.segmentaciones).map((e=>x(e[1],e[0],r.has(e[0]))));j(p,h),u.append(p,...h);let m,f=t.querySelector("#m-selection"),v=x("Todas"),b=Object.entries(i.regiones).map((e=>x(e[1],e[0],r.has(e[0]))));j(v,b),f.append(v,...b);let g=t.querySelector(".main-button");function y(){m={var:L(o),est:L(s),seg:L(u),m:L(f)},g.disabled=!Object.values(m).every((e=>e.length))}for(let e of t.querySelectorAll("input:not([id])"))e.addEventListener("change",y);g.addEventListener("click",(function(){g.disabled=!0,function(e){let t=new URLSearchParams(Object.entries(e).map((e=>[e[0],e[1].map((e=>e.replace(/ /g,"_"))).join(" ")])));history.replaceState(e,""),location.hash="?"+t.toString()}(m)})),function(e,t){let n=e.querySelectorAll(".distr-link > span:last-of-type"),a=[t.descripciones.distribution];for(let e=0;e<n.length;e++)n[e].onclick=function(t){t.preventDefault(),alert(a[e])}}(t,i);let w=t.querySelector(".selection-search input");return w.addEventListener("input",(()=>z(w.value,o,i,y))),w.value&&z(w.value,o,i,y),y(),t}let D=0;async function R(e){scrollTo(0,0);const t=D=(D+1)%Number.MAX_SAFE_INTEGER;let n,a,l=location.hash,i=e?.state;l.length>1&&"?"==l[1]?[n,a]=[w(),T()]:[n,a]=[q(),A(i)],[n,a]=await Promise.all([n,a]),t==D&&(document.querySelector("header").replaceWith(n),document.querySelector("main").replaceWith(a))}window.onpopstate=R,R();
